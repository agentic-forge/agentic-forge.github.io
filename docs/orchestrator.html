<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrator - Agentic Forge</title>
    <meta name="description" content="The Orchestrator manages the LLM conversation loop with model routing, tool routing, and hooks.">
    <link rel="icon" type="image/png" href="../assets/logo.png">
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <a href="../" class="logo">
                <img src="../assets/logo.png" alt="Agentic Forge Logo">
                Agentic<span>Forge</span>
            </a>
            <nav>
                <a href="../">Home</a>
                <a href="./" class="active">Docs</a>
                <a href="https://github.com/agentic-forge">GitHub</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="docs-layout">
            <aside class="docs-sidebar">
                <h4>Documentation</h4>
                <ul>
                    <li><a href="./">Architecture</a></li>
                    <li><a href="./orchestrator.html" class="active">Orchestrator</a></li>
                    <li><a href="./armory.html">Armory</a></li>
                    <li><a href="./anvil.html">Anvil</a></li>
                    <li><a href="./tool-rag.html">Tool RAG</a></li>
                    <li><a href="./interfaces.html">Interfaces</a></li>
                </ul>
            </aside>

            <article class="docs-content">
                <h1><span>Orchestrator</span></h1>
                <p class="lead">
                    A standalone component that manages the LLM conversation loop with advanced routing,
                    execution control, and observability hooks.
                </p>

                <h2>Why a Standalone Orchestrator?</h2>
                <p>
                    While Pydantic AI provides built-in orchestration, a standalone orchestrator offers:
                </p>
                <ul>
                    <li><strong>Rule-based routing</strong> - Route different queries to different models or tools</li>
                    <li><strong>Multi-model orchestration</strong> - Use different models for different tasks</li>
                    <li><strong>Embeddable</strong> - Integrate into existing applications and pipelines</li>
                    <li><strong>Customizable loop</strong> - Inject logic at any point in the execution cycle</li>
                    <li><strong>Observable</strong> - Full visibility into decisions, timing, and costs</li>
                </ul>

                <h2>Architecture</h2>

                <div class="architecture-diagram">
<pre>
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ORCHESTRATOR                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         PUBLIC API                                      │ │
│  │  - run(prompt) → Response                                               │ │
│  │  - run_stream(prompt) → AsyncIterator[Event]                            │ │
│  │  - step() → manually advance one loop iteration                         │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Conversation │  │    Model     │  │     Tool     │  │  Execution   │    │
│  │   Manager    │  │    Router    │  │    Router    │  │   Engine     │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
│                                      │                                       │
│                                      ▼                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         HOOKS / MIDDLEWARE                              │ │
│  │  on_model_request, on_model_response, on_tool_call, on_complete        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
</pre>
                </div>

                <h2>Sub-components</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Responsibility</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Conversation Manager</strong></td>
                            <td>Message history, context limits, conversation forking</td>
                        </tr>
                        <tr>
                            <td><strong>Model Router</strong></td>
                            <td>Rule-based model selection (fast vs smart, code vs chat)</td>
                        </tr>
                        <tr>
                            <td><strong>Tool Router</strong></td>
                            <td>Rule-based routing to MCP servers and backends</td>
                        </tr>
                        <tr>
                            <td><strong>Execution Engine</strong></td>
                            <td>Parallel execution, retries, timeouts, result transformation</td>
                        </tr>
                        <tr>
                            <td><strong>Hooks</strong></td>
                            <td>Middleware for logging, metrics, and custom logic</td>
                        </tr>
                    </tbody>
                </table>

                <h2>Model Router</h2>
                <p>
                    Select different models based on task characteristics:
                </p>

<pre><code>model_router = ModelRouter()
model_router.add_model("fast", ModelConfig("openai", "gpt-4o-mini"))
model_router.add_model("smart", ModelConfig("anthropic", "claude-3-5-sonnet"))
model_router.add_model("code", ModelConfig("anthropic", "claude-3-5-sonnet"))

# Route based on complexity
model_router.add_rule(RoutingRule(
    condition=lambda ctx: ctx.estimated_complexity < 3,
    model_name="fast"
))

# Route based on intent
model_router.add_rule(RoutingRule(
    condition=lambda ctx: "code" in ctx.detected_intent,
    model_name="code"
))</code></pre>

                <h2>Tool Router</h2>
                <p>
                    Route tool calls to appropriate backends based on patterns:
                </p>

<pre><code>tool_router = ToolRouter()
tool_router.add_mcp_server("armory", "http://localhost:8000/mcp")

# Route by prefix
tool_router.add_route(ToolRoute(
    pattern="fs_*",
    destination="filesystem_server"
))

# Route by category
tool_router.add_route(ToolRoute(
    pattern="db_*",
    destination="database_server"
))

# Default to Armory
tool_router.add_route(ToolRoute(
    pattern="*",
    destination="armory"
))</code></pre>

                <h2>Hooks for Observability</h2>
                <p>
                    Register handlers for various events in the orchestration loop:
                </p>

<pre><code>orchestrator = Orchestrator(model_router, tool_router)

@orchestrator.on("model_request")
def log_model_request(data):
    print(f"Calling model: {data['model'].model}")

@orchestrator.on("tool_calls")
async def track_tools(data):
    for call in data["calls"]:
        await metrics.increment(f"tool.{call.name}.calls")

@orchestrator.on("complete")
def track_cost(data):
    cost = calculate_cost(data["usage"])
    budget_tracker.add(cost)</code></pre>

                <h2>Usage Examples</h2>

                <h3>Basic Usage</h3>
<pre><code>from agentic_forge import Orchestrator, ModelRouter, ToolRouter

orchestrator = Orchestrator(
    model_router=ModelRouter(...),
    tool_router=ToolRouter(...)
)

result = await orchestrator.run(
    prompt="Search for AI news and summarize",
    system_prompt="You are a research assistant."
)

print(result.content)</code></pre>

                <h3>Streaming</h3>
<pre><code>async for event in orchestrator.run_stream("Search..."):
    if event.type == "token":
        print(event.token, end="", flush=True)
    elif event.type == "tool_call":
        print(f"\n[Calling {event.tool_name}...]")</code></pre>

                <h3>Embedding in Applications</h3>
<pre><code>from fastapi import FastAPI
from agentic_forge import Orchestrator

app = FastAPI()
orchestrator = Orchestrator(...)

@app.post("/chat")
async def chat(request: ChatRequest):
    result = await orchestrator.run(request.message)
    return {"response": result.content}</code></pre>

                <h2>Comparison with Pydantic AI Agent</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Pydantic AI Agent</th>
                            <th>Standalone Orchestrator</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Setup complexity</td>
                            <td>Simple</td>
                            <td>More configuration</td>
                        </tr>
                        <tr>
                            <td>Routing rules</td>
                            <td>Limited</td>
                            <td>Full control</td>
                        </tr>
                        <tr>
                            <td>Multi-model</td>
                            <td>One model per agent</td>
                            <td>Dynamic selection</td>
                        </tr>
                        <tr>
                            <td>Hooks/middleware</td>
                            <td>Limited</td>
                            <td>Extensive</td>
                        </tr>
                        <tr>
                            <td>Embeddability</td>
                            <td>Agent owns loop</td>
                            <td>Component in your system</td>
                        </tr>
                    </tbody>
                </table>
            </article>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Agentic Forge &copy; 2025 &middot; <a href="https://github.com/agentic-forge">GitHub</a></p>
        </div>
    </footer>
</body>
</html>
